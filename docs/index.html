<!doctype html>
<html>
  <head>
    <title>UDL</title>
    <style>
      button {
        color:white;
        background-color:#444444;
        border-left: 2px #777777 solid;
        border-top: 2px #777777 solid;
        border-bottom: 2px #555555 solid;
        border-right: 2px #555555 solid;
      }
      button:hover {
        color:white;
        background-color:#66666;
        border-left: 2px #999999 solid;
        border-top: 2px #999999 solid;
        border-bottom: 2px #777777 solid;
        border-right: 2px #777777 solid;
      }
    </style>
    <script type="module">
      import init, * as udlwasm from "./udlwasm.js";
      init();
      window.preprocess_latex = udlwasm.preprocess_latex;
      window.preprocess_html = udlwasm.preprocess_html;
    </script>
    <script language="javascript" type="text/javascript" src="codemirror.js"></script>
    <link rel="stylesheet" type="text/css" href="codemirror.css">
    <script src="cm-modes/simple.js"></script>
    <script src="cm-modes/xml.js"></script>
    <script src="cm-modes/stex.js"></script>
    <link rel="stylesheet" href="cm-styles/monokai.css"/>
    <script type="text/javascript">
      window.editor = "temp";
      window.result = "temp";

      // Paste in a HTML preprocessor example.
      function htmlExample() {
        result.setValue(
`# HTML preprocessor example

<@doctype>
<+html> # <+tag> is an opening tag and <-tag> or <-> is a closing tag.
  <+head>
    <+title><@title><->
    <+script src:script.js><->
  <-head>
  <+body>
    <+h1 id:main-heading><@title><->
    <+p>Hello world!<-> # These two paragraph notations are equivalent.
    <p>:{Hello world!}
    <img src:frontpage.jpg>
    <+div class:dark-background><+p>
      This is a paragraph<br>
      with a line break.
      <+em class:italic-text>This text is italic.<->
    <-><->
  <-body>
<-html>
`
        );
        result.setOption("mode", "simple");
      }

      // Preprocess UDL to HTML.
      function processHtml() {
        let inp = editor.getValue();
        let out;
        try {
          out = preprocess_html(inp, true);
        } catch (error) {
          document.getElementById("alert").textContent = error;
          return;
        }
        document.getElementById("alert").textContent = "";
        result.setValue(out);
        result.setOption("mode", "text/html");
      }

      // Paste in a LaTeX preprocessor example.
      function latexExample() {
        result.setValue(
`# LaTeX preprocessor example

<documentclass>:article

<usepackage>:amsmath

<begin>:document

<section>:Equations

  # Define a sum-range command.
  <newcommand>:<SumRn>:*:4:{
    <sum>_{#1}^{#2 <dots> #3} #4
  }

  <begin>:math
    <SumRn>:k:0:100:k
    = 0 + 1 + 2 + <dots> + 99 + 100
    = (0 + 100) + (1 + 99) + <dots> (49 + 51) + 50
    = 5050
  <end>:math

  <begin>:math
    <SumRn>:k:0:n:k
    = 0 + 1 + 2 + <dots> + (n - 1) + n
    = n <cfrac>:n:2 + <cfrac>:n:2
    = <cfrac>:n^2:2 + <cfrac>:n:2
    = n <cdot> <cfrac>:{n + 1}:2
  <end>:math

<section>:Matrices

  <begin>:math
    <mathbf>:X = <begin>:bmatrix <@tabulate-sq>:3:[
      1;0;0;
      0;1;0;
      0;0;1;
    ] <end>:bmatrix
  <end>:math

<end>:document
`
        );
        result.setOption("mode", "simple");
      }

      // Preprocess UDL to LaTeX.
      function processLatex() {
        let inp = editor.getValue();
        let out;
        try {
          out = preprocess_latex(inp);
        } catch (error) {
          document.getElementById("alert").textContent = error;
          return;
        }
        document.getElementById("alert").textContent = "";
        result.setValue(out);
        result.setOption("mode", "text/x-stex");
      }

      window.addEventListener('DOMContentLoaded', () => {
        // Temporary syntax highlighting. TODO: Write a lexer highlighter.
        CodeMirror.defineSimpleMode("simple", {
          start: [
            { regex: /#{2,}.*$/, token: "comment" },
            { regex: /#{1}\s+.*$/, token: "comment" },
            { regex: /<\+{1}|<\-{1}/, token: "tag" },
            { regex: /<{1}|>{1}/, token: "tag" },
            { regex: /\{{1}|\}{1}/, token: "tag" },
            { regex: /\{|\}|\[|\]|\(|\)/, token: "bracket" },
            { regex: /^:{2,}/, token: "string" },
            { regex: /^:{1}/, token: "tag" },
            { regex: /0x[a-f\d]+|[-+]?(?:\.\d+|\d+\.?\d*)(?:e[-+]?\d+)?/i, token: "number" }
          ],
          // The meta property contains global information about the mode. It
          // can contain properties like lineComment, which are supported by
          // all modes, and also directives like dontIndentStates, which are
          // specific to simple modes.
          meta: {
            lineComment: "#"
          }
        });
        // Set up editor area.
        editor = CodeMirror.fromTextArea(document.getElementById("code"), {
          lineNumbers: true,
          mode: 'simple',
          matchBrackets: true,
          theme: "monokai"
        });
        editor.setSize("100%", "100%");
        editor.setOption("mode", "simple");
        // Set up preprocessor result area.
        result = CodeMirror.fromTextArea(document.getElementById("preprocess"), {
          lineNumbers: true,
          matchBrackets: true,
          readOnly: true,
          theme: "monokai"
        });
        result.setSize("100%", "100%");
      });
    </script>
  </head>
  <body style="height: 100%; display:flex; flex-direction:column; width:100%; background-color:#333333">
    <h1 style="color:#dddddd">UDL preprocessor</h1>
    <div>
      <button onclick="processHtml()">Preprocess HTML</button>
      <button onclick="htmlExample()">Example</button>
      <span style="color:white">&middot;</span>
      <button onclick="processLatex()">Preprocess LaTeX</button>
      <button onclick="latexExample()">Example</button>
    </div>
    <div id="alert" style="color:white; padding-top: 0.5em; padding-bottom:0.5em">

    </div>
    <div style="max-width: 99%; min-width:99%; width:99%; height: 100%; display: grid; grid-template-columns: 2fr 2fr; align-items:stretch;border:2px dotted grey;">
      <div style="resize:horizontal; width: 100%; height: 100%;">
        <textarea id="code" name="code" style=""></textarea>
      </div>
      <div style="resize:horizontal; width: 100%; height: 100%;">
        <textarea id="preprocess" name="preprocess"></textarea>
      </div>
    </div>
  </body>
</html>
